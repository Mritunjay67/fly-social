<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLY Social - Notifications</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <img src="images/fly-logo.png" alt="FLY Logo" class="h-10 w-10">
                <span class="font-bold text-xl text-gray-800 hidden md:block">Notifications</span>
            </div>
            
            <nav class="flex items-center space-x-6">
                <button onclick="window.location.href='Home.html'" class="p-2 hover:bg-gray-100 rounded-full text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </button>

                <button class="p-2 bg-purple-50 text-purple-600 rounded-full relative">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                    </svg>
                </button>

                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold cursor-pointer overflow-hidden" onclick="window.location.href='profile.html'">
                    <span id="navUserAvatar">?</span>
                </div>
            </nav>
        </div>
    </header>

    <div class="max-w-2xl mx-auto px-4 py-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[500px]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="font-bold text-lg">Recent</h2>
                <button onclick="markAllRead()" class="text-sm text-purple-600 font-semibold hover:text-purple-800">Mark all as read</button>
            </div>
            <div id="notificationList" class="divide-y divide-gray-50">
                <div class="flex justify-center p-10"><div class="w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('flySocialToken');
        if (!token) { window.location.href = 'Login.html'; return; }
        loadNavAvatar();
        loadNotifications();
    });

    async function loadNavAvatar() {
        const token = localStorage.getItem('flySocialToken');
        try {
            const response = await fetch('/profile', { headers: { 'Authorization': `Bearer ${token}` } });
            const user = await response.json();
            const avatarEl = document.getElementById('navUserAvatar');
            if (user.profilePicture) avatarEl.innerHTML = `<img src="${user.profilePicture}" class="w-full h-full object-cover">`;
            else avatarEl.textContent = user.name.charAt(0).toUpperCase();
        } catch (e) { console.error(e); }
    }

    async function loadNotifications() {
        const list = document.getElementById('notificationList');
        const token = localStorage.getItem('flySocialToken');

        try {
            const response = await fetch('/notifications', { headers: { 'Authorization': `Bearer ${token}` } });
            const notifications = await response.json();
            list.innerHTML = '';

            if (notifications.length === 0) {
                list.innerHTML = `<div class="p-10 text-center text-gray-500">No notifications yet.</div>`;
                return;
            }

            notifications.forEach(notif => {
                let text = '';
                if (notif.type === 'like') text = `liked your post.`;
                else if (notif.type === 'comment') text = `commented: "${notif.commentPreview}"`;
                else if (notif.type === 'follow') text = `started following you.`;

                const userImg = notif.sender.profilePicture ? `<img src="${notif.sender.profilePicture}" class="w-full h-full object-cover">` : `<span class="text-white font-bold">${notif.sender.name.charAt(0)}</span>`;
                
                const div = document.createElement('div');
                div.className = `p-4 flex items-center gap-4 hover:bg-gray-50 transition-colors ${notif.isRead ? 'bg-white' : 'bg-purple-50/30'}`;
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-purple-400 flex items-center justify-center overflow-hidden flex-shrink-0">${userImg}</div>
                    <div class="flex-1 text-sm"><span class="font-bold">${notif.sender.username}</span> ${text}</div>
                `;
                list.appendChild(div);
            });
        } catch (error) { list.innerHTML = `<div class="p-4 text-center text-red-500">Error loading notifications.</div>`; }
    }

    async function markAllRead() {
        const token = localStorage.getItem('flySocialToken');
        await fetch('/notifications', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
        loadNotifications();
    }
    </script>
</body>
</html>